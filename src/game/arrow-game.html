<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
     <meta name="mobile-web-app-capable" content="yes">
     <meta name="apple-mobile-web-app-capable" content="yes">
     <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PPO Arrow Game - COINPAYOT</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_C_O_I_N_P_H_A_N_T_O_M_E_9_9_5_B",
            authDomain: "coinphantom-e995b.firebaseapp.com",
            projectId: "coinphantom-e995b",
            storageBucket: "coinphantom-e995b.appspot.com",
            messagingSenderId: "101010101010",
            appId: "1:101010101010:web:abcdefghijklmnop"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Firestore
        const db = firebase.firestore();

        // Make Firebase available globally
        window.firebase = {
            db: db,
            auth: firebase.auth()
        };

        console.log('Firebase initialized in arrow game');
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js"></script>
    <script src="//s3-us-west-2.amazonaws.com/s.cdpn.io/16327/MorphSVGPlugin.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Web3.js -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
        height: 100vh;
      }

      /* Animated background particles */
      .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 50%;
        animation: float 6s infinite ease-in-out;
      }

      @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0; }
        50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
      }

      /* Weather Effects */
      .weather-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
        overflow: hidden;
      }

      /* Sun Effect */
      .sun {
        position: absolute;
        top: 50px;
        right: 100px;
        width: 80px;
        height: 80px;
        background: radial-gradient(circle, #ffd700 0%, #ff8c00 50%, #ff4500 100%);
        border-radius: 50%;
        box-shadow: 
          0 0 30px rgba(255, 215, 0, 0.8),
          0 0 60px rgba(255, 140, 0, 0.6),
          0 0 90px rgba(255, 69, 0, 0.4);
        animation: sunPulse 4s ease-in-out infinite;
      }

      .sun::before {
        content: '';
        position: absolute;
        top: -20px;
        left: -20px;
        right: -20px;
        bottom: -20px;
        background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
        border-radius: 50%;
        animation: sunGlow 6s ease-in-out infinite;
      }

      @keyframes sunPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      @keyframes sunGlow {
        0%, 100% { opacity: 0.5; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      @keyframes sunRayPulse {
        0%, 100% { opacity: 0.3; transform: rotate(var(--rotation)) translateY(-40px) scale(1); }
        50% { opacity: 1; transform: rotate(var(--rotation)) translateY(-40px) scale(1.1); }
      }

      /* Rain Effect */
      .rain {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, transparent 0%, rgba(0, 150, 255, 0.1) 100%);
        animation: rainFall 2s linear infinite;
      }

      .raindrop {
        position: absolute;
        width: 2px;
        height: 20px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(0, 150, 255, 0.6) 100%);
        border-radius: 0 0 2px 2px;
        animation: raindropFall linear infinite;
      }

      @keyframes rainFall {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100vh); }
      }

      @keyframes raindropFall {
        0% { transform: translateY(-100px); opacity: 1; }
        100% { transform: translateY(100vh); opacity: 0; }
      }

      /* Lightning Effect */
      .lightning {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(ellipse at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        opacity: 0;
        animation: lightningFlash 8s ease-in-out infinite;
      }

      @keyframes lightningFlash {
        0%, 90%, 100% { opacity: 0; }
        5%, 15% { opacity: 0.8; }
        10% { opacity: 0.3; }
      }

      /* Cloud Effect */
      .cloud {
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50px;
        animation: cloudFloat linear infinite;
      }

      .cloud::before,
      .cloud::after {
        content: '';
        position: absolute;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
      }

      .cloud::before {
        width: 60px;
        height: 60px;
        top: -30px;
        left: 20px;
      }

      .cloud::after {
        width: 40px;
        height: 40px;
        top: -20px;
        right: 20px;
      }

      @keyframes cloudFloat {
        0% { transform: translateX(-200px); }
        100% { transform: translateX(calc(100vw + 200px)); }
      }

      /* Enhanced Weather Effects */
      .weather-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 3;
        background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
        opacity: 0;
        transition: opacity 2s ease-in-out;
      }

      .weather-overlay.stormy {
        opacity: 1;
        background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
      }

      .weather-overlay.rainy {
        opacity: 1;
        background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
      }

      /* Rainbow Effect */
      .rainbow {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 150px;
        border-radius: 150px 150px 0 0;
        background: linear-gradient(
          45deg,
          rgba(255, 0, 0, 0.3) 0%,
          rgba(255, 165, 0, 0.3) 16.66%,
          rgba(255, 255, 0, 0.3) 33.33%,
          rgba(0, 255, 0, 0.3) 50%,
          rgba(0, 0, 255, 0.3) 66.66%,
          rgba(238, 130, 238, 0.3) 83.33%,
          rgba(255, 0, 0, 0.3) 100%
        );
        opacity: 0;
        animation: rainbowAppear 4s ease-in-out infinite;
      }

      @keyframes rainbowAppear {
        0%, 100% { opacity: 0; transform: translateX(-50%) scale(0.8); }
        50% { opacity: 1; transform: translateX(-50%) scale(1); }
      }

      /* Modern Game Container */
      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 0;
      }

      /* Back Button */
      .back-button {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #fff;
        color: #fff;
        padding: 10px 15px;
        border-radius: 5px;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: bold;
      }

      .back-button:hover {
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        transform: translateX(-5px);
        text-decoration: none;
      }

      /* Wallet Connection Status */
      .wallet-status {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #fff;
        color: #fff;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 12px;
        font-weight: bold;
      }

      .wallet-status.connected {
        border-color: #28a745;
        color: #28a745;
      }

      .wallet-status.disconnected {
        border-color: #dc3545;
        color: #dc3545;
      }

      /* Modern Header */
      .game-header {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(20px);
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
      }

      .game-title {
        color: #fff;
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .game-title i {
        color: #ffd700;
        font-size: 28px;
      }

      .game-stats {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .stat-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 10px 15px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(10px);
      }

      .stat-card i {
        color: #ffd700;
        font-size: 18px;
      }

      .score-display {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        border: none;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }

      /* Arrow Counter */
      .arrow-counter {
        position: absolute;
        top: 100px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 15px;
        z-index: 50;
      }

      .arrow-counter h3 {
        color: #fff;
        margin-bottom: 10px;
        text-align: center;
        font-size: 16px;
      }

      .arrow-display {
        display: flex;
        gap: 5px;
        justify-content: center;
      }

      .arrow-icon {
        color: #ffd700;
        font-size: 20px;
        transition: all 0.3s ease;
      }

      .arrow-icon.used {
        color: #666;
        opacity: 0.3;
      }

      /* PPO Balance */
      .ppo-balance {
        position: absolute;
        top: 100px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 15px;
        z-index: 50;
      }

      .ppo-balance h3 {
        color: #fff;
        margin-bottom: 5px;
        font-size: 16px;
      }

      .ppo-amount {
        color: #00ff88;
        font-size: 20px;
        font-weight: bold;
        text-align: center;
      }

      /* Game Area */
      .game-area {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        overflow: hidden;
      }

      svg {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 80px;
      }

      /* Target Styles */
      #target {
        transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      /* Bow Styles */
      #bow {
        filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.3));
      }

      /* Controls */
      .game-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 50;
      }

      .control-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }

      .control-btn:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Instructions */
      .instructions {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 15px 25px;
        color: #fff;
        text-align: center;
        z-index: 50;
      }

      /* Game Over Modal */
      .game-over-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        color: white;
        max-width: 400px;
        width: 90%;
        border: 3px solid rgba(255, 255, 255, 0.2);
      }

      .modal-content h2 {
        margin-bottom: 20px;
        font-size: 28px;
        color: #ffd700;
      }

      .final-score {
        font-size: 36px;
        font-weight: bold;
        color: #00ff88;
        margin: 20px 0;
        text-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
      }

      .restart-btn {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
      }

             .restart-btn:hover {
         transform: translateY(-2px);
         box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
       }

       /* Earn PPO Modal Styles */
       .earn-ppo-content {
         margin: 20px 0;
         text-align: left;
       }

       .task-item {
         display: flex;
         align-items: center;
         gap: 10px;
         margin: 10px 0;
         padding: 10px;
         background: rgba(255, 255, 255, 0.1);
         border-radius: 8px;
         color: white;
       }

       .task-item i {
         font-size: 18px;
         width: 20px;
       }

       .task-item span {
         flex: 1;
       }

      /* Hit Messages */
      .hit-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        z-index: 200;
        pointer-events: none;
        opacity: 0;
      }

                     /* Responsive Design - Mobile Optimized */
        @media (max-width: 768px) {
          /* Header - Compact */
          .game-header {
            padding: 8px 10px;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            min-height: 50px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
          }

          .game-title {
            font-size: 16px;
            margin-bottom: 0;
          }

          .game-stats {
            gap: 8px;
            flex-wrap: nowrap;
          }

          .stat-card {
            font-size: 12px;
            padding: 6px 10px;
            min-width: 70px;
          }

          /* Side panels - Fixed at bottom */
          .arrow-counter,
          .ppo-balance {
            position: fixed;
            bottom: 10px;
            top: auto;
            padding: 12px;
            border-radius: 12px;
            max-width: 140px;
            z-index: 150;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
          }

          .arrow-counter {
            right: 10px;
            left: auto;
          }

          .ppo-balance {
            left: 10px;
            right: auto;
          }

          .arrow-counter h3,
          .ppo-balance h3 {
            font-size: 14px;
            margin-bottom: 8px;
            text-align: center;
          }

          .ppo-amount {
            font-size: 18px;
            text-align: center;
          }

          .arrow-display {
            gap: 4px;
            margin-bottom: 8px;
            justify-content: center;
          }

          .arrow-icon {
            font-size: 18px;
          }

          /* Game Controls - Fixed at bottom center */
          .game-controls {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            gap: 10px;
          }

          .control-btn {
            padding: 10px 15px;
            font-size: 13px;
            border-radius: 20px;
          }

          /* Game area - Full screen with proper spacing */
          .game-area {
            margin-top: 60px;
            margin-bottom: 140px;
            padding: 0;
            height: calc(100vh - 200px);
            min-height: 400px;
          }

          svg {
            transform: scale(0.8);
            transform-origin: center;
            max-width: 100%;
            height: 100%;
          }

          /* Instructions - Hidden on mobile to save space */
          .instructions {
            display: none;
          }

          /* Weather effects - Minimal */
          .sun {
            width: 40px;
            height: 40px;
            top: 10px;
        right: 20px;
          }

          .rainbow {
            width: 100px;
            height: 50px;
            top: 10px;
          }

          .cloud {
            transform: scale(0.4);
          }

          /* Modal - Better sizing */
          .modal-content {
            padding: 20px;
            margin: 15px;
            max-width: 95%;
            border-radius: 15px;
          }

          .modal-content h2 {
            font-size: 20px;
          }

          .final-score {
        font-size: 24px;
          }

          .restart-btn {
            padding: 10px 18px;
            font-size: 13px;
            margin: 6px;
          }

          .task-item {
            padding: 8px;
            font-size: 12px;
            margin: 6px 0;
          }

          .task-item i {
            font-size: 14px;
          }
        }

               /* Extra small devices - Ultra compact */
        @media (max-width: 480px) {
          /* Header - Ultra compact */
          .game-header {
            padding: 6px 8px;
            min-height: 45px;
          }

          .game-title {
            font-size: 14px;
            margin-bottom: 0;
          }

          .game-stats {
            gap: 4px;
          }

          .stat-card {
            font-size: 10px;
            padding: 4px 6px;
            min-width: 60px;
          }

          /* Side panels - Ultra compact */
          .arrow-counter,
          .ppo-balance {
            bottom: 5px;
            max-width: 120px;
            padding: 8px;
          }

          .arrow-counter {
            right: 5px;
          }

          .ppo-balance {
            left: 5px;
          }

          .arrow-counter h3,
          .ppo-balance h3 {
            font-size: 12px;
            margin-bottom: 6px;
          }

          .ppo-amount {
            font-size: 16px;
          }

          .arrow-icon {
            font-size: 16px;
          }

          /* Game Controls - Ultra compact */
          .game-controls {
            bottom: 70px;
            gap: 8px;
          }

          .control-btn {
            padding: 8px 12px;
            font-size: 11px;
            border-radius: 15px;
          }

          /* Game area - More space */
          .game-area {
            margin-top: 50px;
            margin-bottom: 120px;
            height: calc(100vh - 170px);
            min-height: 350px;
          }

          svg {
            transform: scale(0.7);
          }

          /* Weather effects - Minimal */
          .sun {
            width: 30px;
            height: 30px;
            top: 5px;
            right: 10px;
          }

          .rainbow {
            width: 80px;
            height: 40px;
            top: 5px;
          }

          .cloud {
            transform: scale(0.3);
          }

          /* Modal - Ultra compact */
          .modal-content {
            padding: 15px;
            margin: 10px;
            max-width: 98%;
          }

          .modal-content h2 {
            font-size: 18px;
          }

          .final-score {
            font-size: 20px;
          }

          .restart-btn {
            padding: 8px 15px;
            font-size: 12px;
            margin: 4px;
          }

          .task-item {
            padding: 6px;
            font-size: 11px;
            margin: 4px 0;
          }

          .task-item i {
            font-size: 12px;
          }
        }

               /* Landscape orientation - Optimized */
        @media (max-width: 768px) and (orientation: landscape) {
          /* Header - Compact horizontal */
          .game-header {
            padding: 6px 10px;
            min-height: 40px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
          }

          .game-title {
            font-size: 14px;
            margin-bottom: 0;
          }

          .game-stats {
            gap: 6px;
            flex-wrap: nowrap;
          }

          .stat-card {
            font-size: 11px;
            padding: 4px 6px;
            min-width: 60px;
          }

          /* Side panels - Bottom positioning for landscape */
          .arrow-counter,
          .ppo-balance {
            position: fixed;
            bottom: 5px;
            top: auto;
            max-width: 120px;
            padding: 8px;
            z-index: 150;
          }

          .arrow-counter {
            right: 5px;
          }

          .ppo-balance {
            left: 5px;
          }

          .arrow-counter h3,
          .ppo-balance h3 {
            font-size: 12px;
            margin-bottom: 6px;
          }

          .ppo-amount {
            font-size: 16px;
          }

          .arrow-icon {
            font-size: 16px;
          }

          /* Game Controls - Bottom center */
          .game-controls {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            gap: 8px;
          }

          .control-btn {
            padding: 8px 12px;
            font-size: 11px;
            border-radius: 15px;
          }

          /* Game area - Optimized for landscape */
          .game-area {
            margin-top: 45px;
            margin-bottom: 100px;
            height: calc(100vh - 145px);
            min-height: 300px;
          }

          svg {
            transform: scale(0.75);
            max-width: 100%;
            height: 100%;
          }

          /* Instructions - Hidden in landscape */
          .instructions {
            display: none;
          }

          /* Weather effects - Minimal for landscape */
          .sun {
            width: 25px;
            height: 25px;
            top: 5px;
            right: 10px;
          }

          .rainbow {
            width: 60px;
            height: 30px;
            top: 5px;
          }

          .cloud {
            transform: scale(0.3);
          }
        }

       /* Touch device optimizations */
       @media (hover: none) and (pointer: coarse) {
         .buy-arrows-btn:hover {
           transform: none;
           box-shadow: none;
         }

         .restart-btn:hover {
           transform: none;
           box-shadow: none;
         }

         .buy-arrows-btn:active,
         .restart-btn:active {
           transform: scale(0.95);
         }
       }

       /* Additional mobile improvements */
       @media (max-width: 768px) {
         /* Prevent overlapping */
         .game-container {
           overflow: hidden;
         }

         /* Better button styling */
         .buy-arrows-btn,
         .restart-btn {
           border: none;
           outline: none;
           -webkit-tap-highlight-color: transparent;
           touch-action: manipulation;
         }

         /* Improved modal positioning */
         .game-over-modal {
           align-items: flex-start;
           padding-top: 20px;
         }

         .modal-content {
           margin: 0 auto;
           max-height: 90vh;
           overflow-y: auto;
         }

         /* Better spacing for small screens */
         .earn-ppo-content {
           max-height: 50vh;
           overflow-y: auto;
         }

         /* Improved task items */
         .task-item {
           border-radius: 8px;
           border: 1px solid rgba(255, 255, 255, 0.1);
         }

         /* Better visual hierarchy */
         .ppo-balance .btn {
           margin-top: 8px;
           width: 100%;
           padding: 8px 12px;
           font-size: 12px;
           border-radius: 15px;
           background: rgba(255, 255, 255, 0.1);
           border: 1px solid rgba(255, 255, 255, 0.2);
           color: white;
         }

         .ppo-balance .btn:hover {
           background: rgba(255, 255, 255, 0.2);
         }
       }

       /* Mobile performance optimizations */
       @media (max-width: 768px) {
         /* Reduce particle count for mobile */
         .particle {
           display: none;
         }
         
         /* Optimize animations for mobile */
         * {
           -webkit-transform: translateZ(0);
           transform: translateZ(0);
           -webkit-backface-visibility: hidden;
           backface-visibility: hidden;
         }
         
         /* Reduce weather effects intensity */
         .sun::before {
           animation-duration: 8s;
         }
         
         .raindrop {
           animation-duration: 1.5s;
         }
         
         /* Optimize modal animations */
         .game-over-modal {
           -webkit-overflow-scrolling: touch;
         }
       }

       /* Prevent text selection on mobile */
       * {
         -webkit-user-select: none;
         -moz-user-select: none;
         -ms-user-select: none;
         user-select: none;
         -webkit-touch-callout: none;
         -webkit-tap-highlight-color: transparent;
       }

       /* Allow text selection in modals */
       .modal-content {
         -webkit-user-select: text;
         -moz-user-select: text;
         -ms-user-select: text;
         user-select: text;
      }
    </style>
  </head>
  <body>
    <!-- Back Button -->
    <a href="game.html" class="back-button">
      <i class="fas fa-arrow-left me-2"></i>Back to Games
    </a>

    <!-- Wallet Status -->
    <div class="wallet-status disconnected" id="walletStatus">
      <i class="fas fa-wallet me-1"></i>Wallet Disconnected
    </div>

    <!-- Animated Background Particles -->
    <div class="particles" id="particles"></div>

    <!-- Weather Effects Container -->
    <div class="weather-container" id="weatherContainer">
      <!-- Sun Effect -->
      <div class="sun" id="sun"></div>
      
      <!-- Rain Effect -->
      <div class="rain" id="rain"></div>
      
      <!-- Lightning Effect -->
      <div class="lightning" id="lightning"></div>
      
      <!-- Rainbow Effect -->
      <div class="rainbow" id="rainbow"></div>
      
      <!-- Clouds -->
      <div class="cloud" id="cloud1" style="width: 120px; height: 40px; top: 80px; animation-duration: 20s;"></div>
      <div class="cloud" id="cloud2" style="width: 100px; height: 35px; top: 120px; animation-duration: 25s; animation-delay: 5s;"></div>
      <div class="cloud" id="cloud3" style="width: 140px; height: 45px; top: 60px; animation-duration: 30s; animation-delay: 10s;"></div>
    </div>

    <!-- Weather Overlay -->
    <div class="weather-overlay" id="weatherOverlay"></div>

    <!-- Game Container -->
    <div class="game-container">
      <!-- Header -->
      <div class="game-header">
        <div class="game-title">
          <i class="fas fa-crosshairs"></i>
          PPO Archery
        </div>
        <div class="game-stats">
          <div class="stat-card">
            <i class="fas fa-trophy"></i>
            <span>High: <span id="highScore">0</span></span>
          </div>
          <div class="stat-card">
            <i class="fas fa-star"></i>
            <span>Level: <span id="currentLevel">1</span></span>
          </div>
          <div class="stat-card score-display">
            <i class="fas fa-bullseye"></i>
            <span>Score: <span id="score">0</span></span>
          </div>
        </div>
      </div>

      <!-- Arrow Counter -->
      <div class="arrow-counter">
        <h3><i class="fas fa-arrows-alt"></i> Arrows</h3>
        <div class="arrow-display" id="arrowDisplay"></div>
      </div>

      <!-- PPO Balance -->
      <div class="ppo-balance">
        <h3><i class="fas fa-coins"></i> PPO</h3>
        <div class="ppo-amount" id="ppoBalance">0</div>
      </div>

      <!-- Game Controls -->
      <div class="game-controls">
        <button class="control-btn" onclick="buyArrows()" id="buyArrowsBtn">
          <i class="fas fa-shopping-cart"></i> Buy Arrows
        </button>
        <button class="control-btn" onclick="openDailyTasks()">
          <i class="fas fa-tasks"></i> Daily Tasks
        </button>
      </div>

      <!-- Game Area -->
      <div class="game-area">
    <svg id="game" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 400" overflow="visible">
          <!-- Arc Gradient -->
          <linearGradient id="ArcGradient">
            <stop offset="0" stop-color="#fff" stop-opacity=".2"/>
          <stop offset="50%" stop-color="#fff" stop-opacity="0"/>
      </linearGradient>
          
          <!-- Trajectory Arc -->
          <path id="arc" fill="none" stroke="url(#ArcGradient)" stroke-width="4" d="M100,250c250-400,550-400,800,0" pointer-events="none"/>
          
          <!-- Arrow Definition -->
        <defs>
            <g id="arrow">
              <line x2="60" fill="none" stroke="#ffd700" stroke-width="3"/>
              <polygon fill="#ffd700" points="64 0 58 2 56 0 58 -2"/>
              <polygon fill="#ff6b6b" points="2 -3 -4 -3 -1 0 -4 3 2 3 5 0"/>
            </g>
        </defs>
          
          <!-- Target -->
        <g id="target" transform="translate(0,0)">
            <path fill="#FFF" d="M924.2,274.2c-21.5,21.5-45.9,19.9-52,3.2c-4.4-12.1,2.4-29.2,14.2-41c11.8-11.8,29-18.6,41-14.2 C944.1,228.3,945.7,252.8,924.2,274.2z"/>
            <path fill="#F4531C" d="M915.8,265.8c-14.1,14.1-30.8,14.6-36,4.1c-4.1-8.3,0.5-21.3,9.7-30.5s22.2-13.8,30.5-9.7 C930.4,235,929.9,251.7,915.8,265.8z"/>
            <path fill="#FFF" d="M908.9,258.9c-8,8-17.9,9.2-21.6,3.5c-3.2-4.9-0.5-13.4,5.6-19.5c6.1-6.1,14.6-8.8,19.5-5.6 C918.1,241,916.9,250.9,908.9,258.9z"/>
            <path fill="#F4531C" d="M903.2,253.2c-2.9,2.9-6.7,3.6-8.3,1.7c-1.5-1.8-0.6-5.4,2-8c2.6-2.6,6.2-3.6,8-2 C906.8,246.5,906.1,250.2,903.2,253.2z"/>
          </g>
          
          <!-- Bow -->
        <g id="bow" fill="none" stroke-linecap="round" vector-effect="non-scaling-stroke" pointer-events="none">
          <polyline fill="none" stroke="#ddd" stroke-linecap="round" points="88,200 88,250 88,300"/>
            <path fill="none" stroke="#ffd700" stroke-width="3" stroke-linecap="round" d="M88,300 c0-10.1,12-25.1,12-50s-12-39.9-12-50"/>
        </g>
          
          <!-- Current Arrow -->
      <g class="arrow-angle"><use x="100" y="250" xlink:href="#arrow"/></g>
          
          <!-- Arrow Container -->
      <clipPath id="mask">
        <polygon opacity=".5" points="0,0 1500,0 1500,200 970,290 950,240 925,220 875,280 890,295 920,310 0,350" pointer-events="none"/>
      </clipPath>
          <g class="arrows" clip-path="url(#mask)" pointer-events="none"></g>
          
          <!-- Hit Messages -->
     <g class="missyou" fill="#aaa" opacity="0" transform="translate(-50, 50)">
      <path d="M358 194L363 118 386 120 400 153 416 121 440 119 446 203 419 212 416 163 401 180 380 160 381 204"/>
      <path d="M450 120L458 200 475 192 474 121"/>
      <path d="M537 118L487 118 485 160 515 162 509 177 482 171 482 193 529 199 538 148 501 146 508 133 537 137"/>
      <path d="M540 202L543 178 570 186 569 168 544 167 546 122 590 116 586 142 561 140 560 152 586 153 586 205"/>
      <path d="M630 120 L650 160 L670 120 L690 120 L660 170 L660 200 L640 200 L640 170 L610 120 Z"/>
      <path d="M700 160 A20 20 0 1 1 699.9 160"/>
      <path d="M730 140 L730 180 A20 20 0 0 0 770 180 L770 140 L750 140 L750 180 A5 5 0 0 1 750 180 L750 140 Z"/>
      <path d="M790 150 L790 180 L810 180 L810 100 Z M790 200 L810 200 L810 220 L790 220 Z"/>
    </g>

    <g class="loveyou" fill="#F4531C" opacity="0" transform="translate(300, 100)">
      <path d="M0 0 L0 80 L30 80 L30 70 L10 70 L10 0 Z"/>
      <path d="M50 40 A20 20 0 1 1 49.9 40"/>
      <path d="M80 0 L100 80 L120 0 L110 0 L100 60 L90 0 Z"/>
      <path d="M140 0 L140 80 L170 80 L170 70 L150 70 L150 50 L170 50 L170 40 L150 40 L150 10 L170 10 L170 0 Z"/>
      <path d="M190 0 L205 30 L220 0 L230 0 L210 40 L210 80 L200 80 L200 40 L180 0 Z"/>
      <path d="M250 40 A20 20 0 1 1 249.9 40"/>
      <path d="M280 0 L280 50 A20 20 0 0 0 320 50 L320 0 L310 0 L310 50 A10 10 0 0 1 290 50 L290 0 Z"/>
    </g>
          
          <g class="hit" fill="#ffcc00" opacity="0" transform="translate(180, -80) rotate(12)">
        <path d="M383 114L385 195 407 191 406 160 422 155 418 191 436 189 444 112 423 119 422 141 407 146 400 113"/>
        <path d="M449 185L453 113 477 112 464 186"/>
        <path d="M486 113L484 130 506 130 481 188 506 187 520 131 540 135 545 119"/>
        <path d="M526,195l5-20l22,5l-9,16L526,195z M558,164l32-44l-35-9l-19,51L558,164z"/>
      </g>
    </svg>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        <i class="fas fa-mouse"></i> Click and drag to aim, release to shoot!
      </div>
    </div>

    <!-- Game Over Modal -->
    <div class="game-over-modal" id="gameOverModal">
      <div class="modal-content">
        <h2><i class="fas fa-gamepad"></i> Game Over!</h2>
        <div class="final-score" id="finalScore">Score: 0</div>
        <p>You've run out of arrows!</p>
        <button class="restart-btn" onclick="restartGame()">
          <i class="fas fa-redo"></i> Play Again
        </button>
        <button class="restart-btn" onclick="buyArrows()">
          <i class="fas fa-shopping-cart"></i> Buy More Arrows
        </button>
        <button class="restart-btn" onclick="showEarnPPOModal()">
          <i class="fas fa-coins"></i> How to Earn PPO
        </button>
      </div>
    </div>

    <!-- Earn PPO Modal -->
    <div class="game-over-modal" id="earnPPOModal">
      <div class="modal-content">
        <h2><i class="fas fa-coins"></i> How to Earn PPO</h2>
        <div class="earn-ppo-content">
          <div class="task-item">
            <i class="fas fa-calendar-check text-success"></i>
            <span><strong>Daily Check-in:</strong> 1 PPO per day</span>
          </div>
          <div class="task-item">
            <i class="fas fa-telegram text-info"></i>
            <span><strong>Join Telegram Group:</strong> 2 PPO</span>
          </div>
          <div class="task-item">
            <i class="fas fa-broadcast-tower text-primary"></i>
            <span><strong>Follow Telegram Channel:</strong> 2 PPO</span>
          </div>
          <div class="task-item">
            <i class="fas fa-facebook text-primary"></i>
            <span><strong>Like Facebook Page:</strong> 2 PPO</span>
          </div>
          <div class="task-item">
            <i class="fas fa-twitter text-info"></i>
            <span><strong>Follow Twitter:</strong> 2 PPO</span>
          </div>
          <div class="task-item">
            <i class="fas fa-share-alt text-warning"></i>
            <span><strong>Share on Social Media:</strong> 3 PPO</span>
          </div>
          <div class="task-item">
            <i class="fas fa-star text-warning"></i>
            <span><strong>Level Up in Game:</strong> 2 PPO per level</span>
          </div>
        </div>
        <button class="restart-btn" onclick="openDailyTasks()">
          <i class="fas fa-tasks"></i> Go to Daily Tasks
        </button>
        <button class="restart-btn" onclick="closeEarnPPOModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>

    <script>
      // Game State
      let gameState = {
        score: 0,
        highScore: localStorage.getItem('highScore') || 0,
        arrowsLeft: 5,
        ppoBalance: 0,
        currentLevel: 1,
        hitCount: 0,
        isGameActive: true,
        currentUser: null,
        stuckArrows: [] // Array to track stuck arrows
      };

      // Game Variables
      var svg = document.querySelector("svg");
      var cursor = svg.createSVGPoint();
      var arrows = document.querySelector(".arrows");
      var randomAngle = 0;
      var initialTargetX = 900;
      var distanceIncrement = 50;

      let target = { x: initialTargetX, y: 249.5 };
      let lineSegment = { x1: 875, y1: 280, x2: 925, y2: 220 };
      let pivot = { x: 100, y: 250 };

             // Initialize Game
       async function initGame() {
         await checkUserAuthentication();
         await loadUserData();
         updateUI();
         createParticles();
         createWeatherEffects();
         aim({ clientX: 320, clientY: 300 });
         
         // Add both mouse and touch events for mobile compatibility
         window.addEventListener("mousedown", draw);
         window.addEventListener("touchstart", handleTouchStart, { passive: false });
         
         // Prevent zoom on double tap for mobile
         let lastTouchEnd = 0;
         document.addEventListener('touchend', function (event) {
           const now = (new Date()).getTime();
           if (now - lastTouchEnd <= 300) {
             event.preventDefault();
           }
           lastTouchEnd = now;
         }, false);
       }

      // Update UI
      function updateUI() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('highScore').textContent = gameState.highScore;
        document.getElementById('currentLevel').textContent = gameState.currentLevel;
        document.getElementById('ppoBalance').textContent = gameState.ppoBalance;
        
        // Update arrow display
        const arrowDisplay = document.getElementById('arrowDisplay');
        arrowDisplay.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
          const arrowIcon = document.createElement('i');
          arrowIcon.className = `fas fa-arrow-right arrow-icon ${i >= gameState.arrowsLeft ? 'used' : ''}`;
          arrowDisplay.appendChild(arrowIcon);
        }
        
        // Update buy button state
        const buyBtn = document.getElementById('buyArrowsBtn');
        buyBtn.disabled = gameState.ppoBalance < 10;
      }

             // Create background particles
       function createParticles() {
         const particlesContainer = document.getElementById('particles');
         const isMobile = window.innerWidth <= 768;
         const particleCount = isMobile ? 0 : 50; // No particles on mobile for performance
         
         for (let i = 0; i < particleCount; i++) {
           const particle = document.createElement('div');
           particle.className = 'particle';
           particle.style.left = Math.random() * 100 + '%';
           particle.style.top = Math.random() * 100 + '%';
           particle.style.animationDelay = Math.random() * 6 + 's';
           particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
           particlesContainer.appendChild(particle);
         }
       }

      // Create weather effects
      function createWeatherEffects() {
        createRaindrops();
        createSunRays();
        startWeatherCycle();
      }

      // Create raindrops
      function createRaindrops() {
        const rainContainer = document.getElementById('rain');
        const raindropCount = 100;
        
        for (let i = 0; i < raindropCount; i++) {
          const raindrop = document.createElement('div');
          raindrop.className = 'raindrop';
          raindrop.style.left = Math.random() * 100 + '%';
          raindrop.style.animationDelay = Math.random() * 2 + 's';
          raindrop.style.animationDuration = (Math.random() * 1 + 1) + 's';
          rainContainer.appendChild(raindrop);
        }
      }

      // Create sun rays
      function createSunRays() {
        const sun = document.getElementById('sun');
        const rayCount = 12;
        
        for (let i = 0; i < rayCount; i++) {
          const ray = document.createElement('div');
          ray.style.position = 'absolute';
          ray.style.width = '4px';
          ray.style.height = '60px';
          ray.style.background = 'linear-gradient(180deg, rgba(255, 215, 0, 0.8) 0%, transparent 100%)';
          ray.style.transformOrigin = 'center bottom';
          ray.style.setProperty('--rotation', `${i * 30}deg`);
          ray.style.transform = `rotate(${i * 30}deg) translateY(-40px)`;
          ray.style.animation = `sunRayPulse ${2 + Math.random()}s ease-in-out infinite`;
          ray.style.animationDelay = Math.random() * 2 + 's';
          sun.appendChild(ray);
        }
      }

      // Weather cycle
      function startWeatherCycle() {
        let currentWeather = 'sunny';
        const weatherStates = ['sunny', 'rainy', 'stormy'];
        let weatherIndex = 0;

        // Start with sunny weather
        changeWeather('sunny');

        setInterval(() => {
          weatherIndex = (weatherIndex + 1) % weatherStates.length;
          changeWeather(weatherStates[weatherIndex]);
        }, 20000); // Change weather every 20 seconds
      }

      // Change weather
      function changeWeather(weatherType) {
        const sun = document.getElementById('sun');
        const rain = document.getElementById('rain');
        const lightning = document.getElementById('lightning');
        const rainbow = document.getElementById('rainbow');
        const weatherOverlay = document.getElementById('weatherOverlay');
        const clouds = document.querySelectorAll('.cloud');

        // Reset all weather effects
        sun.style.opacity = '0';
        rain.style.opacity = '0';
        lightning.style.opacity = '0';
        rainbow.style.opacity = '0';
        weatherOverlay.className = 'weather-overlay';
        
        clouds.forEach(cloud => {
          cloud.style.opacity = '0';
          cloud.style.background = 'rgba(255, 255, 255, 0.8)';
        });

        // Apply new weather
        switch(weatherType) {
          case 'sunny':
            sun.style.opacity = '1';
            rainbow.style.opacity = '1';
            clouds.forEach((cloud, index) => {
              cloud.style.opacity = '0.8';
              cloud.style.animationDelay = index * 2 + 's';
            });
            break;
          case 'rainy':
            rain.style.opacity = '1';
            weatherOverlay.classList.add('rainy');
            clouds.forEach((cloud, index) => {
              cloud.style.opacity = '0.9';
              cloud.style.background = 'rgba(100, 100, 100, 0.9)';
            });
            break;
          case 'stormy':
            rain.style.opacity = '1';
            lightning.style.opacity = '1';
            weatherOverlay.classList.add('stormy');
            clouds.forEach((cloud, index) => {
              cloud.style.opacity = '1';
              cloud.style.background = 'rgba(50, 50, 50, 1)';
            });
            break;
        }

        // Show weather notification
        showWeatherNotification(weatherType);
      }

      // Show weather notification
      function showWeatherNotification(weatherType) {
        const messages = {
          'sunny': '☀️ Beautiful sunny day! Perfect for archery!',
          'rainy': '🌧️ Rain is falling... Watch your aim!',
          'stormy': '⛈️ Storm is brewing! Lightning may affect your shots!'
        };

        showNotification(messages[weatherType], 'info');
      }

      // Check user authentication
      async function checkUserAuthentication() {
        try {
          // Check if user is already authenticated via wallet connection
          const connectedWallet = localStorage.getItem('connectedWallet');
          const userUid = localStorage.getItem('userUid');
          
          if (connectedWallet && userUid) {
            // User is connected via wallet
            gameState.currentUser = {
              uid: userUid,
              walletAddress: connectedWallet
            };
            console.log('User authenticated via wallet:', userUid);
            return;
          }
          
          // Check Firebase Auth as fallback
          const { auth } = window.firebase;
          const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js');
          
          return new Promise((resolve) => {
            onAuthStateChanged(auth, (user) => {
              if (user) {
                gameState.currentUser = user;
                console.log('User authenticated via Firebase:', user.uid);
              } else {
                console.log('No user authenticated');
                showNotification('Please connect your wallet to play!', 'error');
              }
              resolve();
            });
          });
        } catch (error) {
          console.error('Error checking authentication:', error);
        }
      }

      // Load user data from Firebase
      async function loadUserData() {
        try {
          if (!gameState.currentUser) {
            console.log('No user to load data for');
            return;
          }

          // Wait for Firebase service to be available
          let attempts = 0;
          const maxAttempts = 20;
          
          while (attempts < maxAttempts) {
            if (window.FirebaseService) {
              break;
            }
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }

          if (!window.FirebaseService) {
            console.error('FirebaseService not available');
            showNotification('Failed to load user data - service unavailable', 'error');
            return;
          }

          // Load PPO balance
          const balanceResult = await window.FirebaseService.getTokenBalance(gameState.currentUser.uid);
          if (balanceResult.success) {
            gameState.ppoBalance = balanceResult.data.ppoBalance || 0;
            console.log('Loaded PPO balance:', gameState.ppoBalance);
          } else {
            console.error('Failed to load balance:', balanceResult.error);
            gameState.ppoBalance = 0;
          }

          // Load high score from localStorage (game specific)
          gameState.highScore = localStorage.getItem('highScore') || 0;
          
          // Load user profile if available
          try {
            const profileResult = await window.FirebaseService.getUserProfile(gameState.currentUser.uid);
            if (profileResult.success) {
              gameState.userProfile = profileResult.data;
              console.log('Loaded user profile:', gameState.userProfile);
            } else {
              // Create new user profile
              await createUserProfile();
            }
          } catch (error) {
            console.log('No user profile found, creating new one');
            await createUserProfile();
          }
          
        } catch (error) {
          console.error('Error loading user data:', error);
          showNotification('Failed to load user data', 'error');
        }
      }

      // Buy arrows function
      async function buyArrows() {
        if (!gameState.currentUser) {
          showNotification('Please connect your wallet first!', 'error');
          return;
        }

        if (gameState.ppoBalance >= 10) {
          try {
            // Update PPO balance in Firebase
            const result = await window.FirebaseService.updateTokenBalance(
              gameState.currentUser.uid, 
              10, 
              'subtract'
            );

            if (result.success) {
              gameState.ppoBalance -= 10;
              gameState.arrowsLeft += 5;
              gameState.isGameActive = true;
              
              updateUI();
              
              // Hide game over modal if open
              document.getElementById('gameOverModal').style.display = 'none';
              
              showNotification('5 arrows purchased for 10 PPO!', 'success');
            } else {
              showNotification('Failed to purchase arrows', 'error');
            }
          } catch (error) {
            console.error('Error buying arrows:', error);
            showNotification('Error purchasing arrows', 'error');
          }
                 } else {
           showNotification('Not enough PPO! Complete daily tasks to earn more!', 'error');
           setTimeout(() => {
             showEarnPPOModal();
           }, 2000);
         }
      }

             // Show notification
       function showNotification(message, type) {
         const notification = document.createElement('div');
         const colors = {
           'success': '#00ff88',
           'error': '#ff6b6b',
           'info': '#4a90e2'
         };
         
         const isMobile = window.innerWidth <= 768;
         
         notification.style.cssText = `
           position: fixed;
           top: ${isMobile ? '10px' : '20px'};
           ${isMobile ? 'left: 50%; transform: translateX(-50%);' : 'right: 20px;'}
           background: ${colors[type] || colors.info};
           color: white;
           padding: ${isMobile ? '12px 20px' : '15px 25px'};
           border-radius: 10px;
           font-weight: bold;
           z-index: 10000;
           animation: slideIn 0.3s ease;
           box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
           backdrop-filter: blur(10px);
           font-size: ${isMobile ? '14px' : '16px'};
           max-width: ${isMobile ? '90%' : 'auto'};
           text-align: center;
           word-wrap: break-word;
         `;
         notification.textContent = message;
         document.body.appendChild(notification);
         
         setTimeout(() => {
           notification.remove();
         }, 3000);
       }

      // Move target farther
      async function moveTargetFarther() {
        gameState.hitCount++;
        gameState.score += Math.floor(gameState.currentLevel * 10);
        
        // Level up every 5 hits
        if (gameState.hitCount % 5 === 0) {
          gameState.currentLevel++;
          showNotification(`Level Up! Now Level ${gameState.currentLevel}`, 'success');
          
          // Reward PPO for leveling up
          if (gameState.currentUser) {
            try {
              const levelReward = Math.floor(gameState.currentLevel * 2); // 2 PPO per level
              await window.FirebaseService.updateTokenBalance(
                gameState.currentUser.uid, 
                levelReward, 
                'add'
              );
              gameState.ppoBalance += levelReward;
              showNotification(`Level Up Reward: +${levelReward} PPO!`, 'success');
            } catch (error) {
              console.error('Error giving level reward:', error);
            }
          }
        }
        
        let offsetX = gameState.hitCount * distanceIncrement;
        
        target.x = initialTargetX + offsetX;
        lineSegment.x1 = 875 + offsetX;
        lineSegment.x2 = 925 + offsetX;
        
        let arcPath = "M100,250c250-400,550-400," + (800 + offsetX) + ",0";
        TweenMax.to("#arc", 0.3, {
          attr: { d: arcPath }
        });
        
        TweenMax.to("#target", 0.5, {
          x: offsetX,
          ease: Back.easeOut.config(1.7),
          onComplete: function() {
            TweenMax.to("#target", 0.3, {
              y: -20,
              yoyo: true,
              repeat: 1,
              ease: Power2.easeInOut
            });
          }
        });

        updateUI();
        
        // Update high score
        if (gameState.score > gameState.highScore) {
          gameState.highScore = gameState.score;
          localStorage.setItem('highScore', gameState.highScore);
          showNotification('New High Score!', 'success');
        }
        
        // Log game transaction to database
        if (gameState.currentUser) {
          try {
            await window.FirebaseService.logTransaction(gameState.currentUser.uid, {
              type: 'game_earned',
              amount: Math.floor(gameState.currentLevel * 10),
              score: gameState.score,
              level: gameState.currentLevel,
              description: `Game reward for level ${gameState.currentLevel}`,
              timestamp: new Date()
            });
          } catch (error) {
            console.error('Error logging game transaction:', error);
          }
        }
        
        TweenMax.fromTo('#score', 0.3, 
          {scale: 1.5, color: '#ffcc00'}, 
          {scale: 1, color: '#88ce02', ease: Back.easeOut}
        );
      }

             // Touch event handlers for mobile
       function handleTouchStart(e) {
         e.preventDefault();
         if (!gameState.isGameActive || gameState.arrowsLeft <= 0) {
           return;
         }
         
         const touch = e.touches[0];
         const mouseEvent = new MouseEvent('mousedown', {
           clientX: touch.clientX,
           clientY: touch.clientY
         });
         
         draw(mouseEvent);
         
         window.addEventListener("touchmove", handleTouchMove, { passive: false });
         window.addEventListener("touchend", handleTouchEnd, { passive: false });
       }
       
       function handleTouchMove(e) {
         e.preventDefault();
         const touch = e.touches[0];
         const mouseEvent = new MouseEvent('mousemove', {
           clientX: touch.clientX,
           clientY: touch.clientY
         });
         
         aim(mouseEvent);
       }
       
       function handleTouchEnd(e) {
         e.preventDefault();
         const mouseEvent = new MouseEvent('mouseup');
         loose(mouseEvent);
         
         window.removeEventListener("touchmove", handleTouchMove);
         window.removeEventListener("touchend", handleTouchEnd);
       }

       // Draw function
       function draw(e) {
         if (!gameState.isGameActive || gameState.arrowsLeft <= 0) {
           return;
         }
         
        randomAngle = Math.random() * Math.PI * 0.03 - 0.015;
        TweenMax.to(".arrow-angle use", 0.3, { opacity: 1});
        window.addEventListener("mousemove", aim);
        window.addEventListener("mouseup", loose);
        aim(e);
      }

      // Aim function
      function aim(e) {
        var point = getMouseSVG(e);
        point.x = Math.min(point.x, pivot.x - 7);
        point.y = Math.max(point.y, pivot.y + 7);
        var dx = point.x - pivot.x;
        var dy = point.y - pivot.y;
        var angle = Math.atan2(dy, dx) + randomAngle;
        var bowAngle = angle - Math.PI;
        var maxPull = 50 + (gameState.hitCount * 10);
        var distance = Math.min(Math.sqrt(dx * dx + dy * dy), maxPull);
        var scale = Math.min(Math.max(distance / 30, 1), 2);
        
        TweenMax.to("#bow", 0.3, {
          scaleX: scale,
          rotation: bowAngle + "rad",
          transformOrigin: "right center"
        });
        
        var arrowX = Math.min(pivot.x - (1 / scale) * distance, 88);
        TweenMax.to(".arrow-angle", 0.3, {
          rotation: bowAngle + "rad",
          svgOrigin: "100 250"
        });
        
        TweenMax.to(".arrow-angle use", 0.3, {
          x: -distance
        });
        
        TweenMax.to("#bow polyline", 0.3, {
          attr: {
            points: "88,200 " + Math.min(pivot.x - (1 / scale) * distance, 88) + ",250 88,300"
          }
        });

        var radius = distance * 9;
        var offset = {
          x: Math.cos(bowAngle) * radius,
          y: Math.sin(bowAngle) * radius
        };
        var arcWidth = offset.x * 3;

        TweenMax.to("#arc", 0.3, {
          attr: {
            d: "M100,250c" + offset.x + "," + offset.y + "," + (arcWidth - offset.x) + "," + (offset.y + 50) + "," + arcWidth + ",50"
          },
          autoAlpha: distance / 60
        });
      }

      // Loose function
      function loose() {
        if (!gameState.isGameActive || gameState.arrowsLeft <= 0) {
          return;
        }
        
        window.removeEventListener("mousemove", aim);
        window.removeEventListener("mouseup", loose);

        // Decrease arrows
        gameState.arrowsLeft--;
        updateUI();

        TweenMax.to("#bow", 0.4, {
          scaleX: 1,
          transformOrigin: "right center",
          ease: Elastic.easeOut
        });
        
        TweenMax.to("#bow polyline", 0.4, {
          attr: { points: "88,200 88,250 88,300" },
          ease: Elastic.easeOut
        });
        
        var newArrow = document.createElementNS("http://www.w3.org/2000/svg", "use");
        newArrow.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#arrow");
        arrows.appendChild(newArrow);

        var path = MorphSVGPlugin.pathDataToBezier("#arc");
        TweenMax.to([newArrow], 0.5, {
          force3D: true,
          bezier: {
            type: "cubic",
            values: path,
            autoRotate: ["x", "y", "rotation"]
          },
          onUpdate: hitTest,
          onUpdateParams: ["{self}"],
          onComplete: onMiss,
          ease: Linear.easeNone
        });
        
        TweenMax.to("#arc", 0.3, { opacity: 0 });
        TweenMax.set(".arrow-angle use", { opacity: 0 });
        
        // Check if game over
        if (gameState.arrowsLeft <= 0) {
          setTimeout(() => {
            gameOver();
          }, 1000);
        }
      }

      // Hit test function
      function hitTest(tween) {
        var arrow = tween.target[0];
        var transform = arrow._gsTransform;
        var radians = (transform.rotation * Math.PI) / 180;
        var arrowSegment = {
          x1: transform.x,
          y1: transform.y,
          x2: Math.cos(radians) * 60 + transform.x,
          y2: Math.sin(radians) * 60 + transform.y
        };

        var intersection = getIntersection(arrowSegment, lineSegment);
        if (intersection.segment1 && intersection.segment2) {
          tween.pause();
          var dx = intersection.x - target.x;
          var dy = intersection.y - target.y;
          var distance = Math.sqrt(dx * dx + dy * dy);
          var selector = ".hit";
          
          if (distance < 7) {
            selector = ".loveyou";
            moveTargetFarther();
          }
          
          showMessage(selector);
        }
      }

      // On miss function
      function onMiss() {
        showMessage(".missyou");
      }

      // Show message function
      function showMessage(selector) {
        TweenMax.killTweensOf(selector);
        TweenMax.killChildTweensOf(selector);
        TweenMax.set(selector, { autoAlpha: 1 });
        
        TweenMax.staggerFromTo(
          selector + " path",
          0.5,
          { rotation: -5, scale: 0, transformOrigin: "center" },
          { scale: 1, ease: Back.easeOut },
          0.05
        );
        
        TweenMax.staggerTo(
          selector + " path",
          0.3,
          { delay: 2, rotation: 20, scale: 0, ease: Back.easeIn },
          0.03
        );
      }

      // Game over function
      async function gameOver() {
        gameState.isGameActive = false;
        document.getElementById('finalScore').textContent = `Score: ${gameState.score}`;
        document.getElementById('gameOverModal').style.display = 'flex';
        
        // Log final game results to database
        if (gameState.currentUser) {
          try {
            // Log game completion
            await window.FirebaseService.logTransaction(gameState.currentUser.uid, {
              type: 'game_completed',
              amount: gameState.score,
              score: gameState.score,
              level: gameState.currentLevel,
              arrowsUsed: 5 - gameState.arrowsLeft,
              description: `Game completed with score ${gameState.score}`,
              timestamp: new Date()
            });
            
            // Update user profile with game stats
            if (gameState.userProfile) {
              const updatedStats = {
                ...gameState.userProfile.gameStats,
                totalGames: (gameState.userProfile.gameStats.totalGames || 0) + 1,
                totalScore: (gameState.userProfile.gameStats.totalScore || 0) + gameState.score,
                bestScore: Math.max(gameState.userProfile.gameStats.bestScore || 0, gameState.score),
                totalPPOEarned: (gameState.userProfile.gameStats.totalPPOEarned || 0) + gameState.score
              };
              
              await window.FirebaseService.createOrUpdateUser({
                ...gameState.userProfile,
                gameStats: updatedStats,
                updatedAt: new Date()
              });
              
              gameState.userProfile.gameStats = updatedStats;
            }
          } catch (error) {
            console.error('Error logging game completion:', error);
          }
        }
      }

      // Open daily tasks page
      function openDailyTasks() {
        if (!gameState.currentUser) {
          showNotification('Please connect your wallet first!', 'error');
          return;
        }
        
        // Redirect to daily tasks page
        window.location.href = 'tasks-section.html';
      }

      // Show earn PPO modal
      function showEarnPPOModal() {
        document.getElementById('earnPPOModal').style.display = 'flex';
      }

      // Close earn PPO modal
      function closeEarnPPOModal() {
        document.getElementById('earnPPOModal').style.display = 'none';
      }

      // Create user profile
      async function createUserProfile() {
        try {
          if (!gameState.currentUser) return;
          
          const userData = {
            uid: gameState.currentUser.uid,
            walletAddress: gameState.currentUser.walletAddress || gameState.currentUser.email,
            username: `Player_${gameState.currentUser.uid.slice(0, 8)}`,
            email: gameState.currentUser.email || '',
            createdAt: new Date(),
            updatedAt: new Date(),
            gameStats: {
              totalGames: 0,
              totalScore: 0,
              bestScore: 0,
              totalPPOEarned: 0
            }
          };
          
          const result = await window.FirebaseService.createOrUpdateUser(userData);
          if (result.success) {
            gameState.userProfile = userData;
            console.log('Created new user profile:', userData);
          }
        } catch (error) {
          console.error('Error creating user profile:', error);
        }
      }

      // Restart game function
      function restartGame() {
        gameState.score = 0;
        gameState.hitCount = 0;
        gameState.currentLevel = 1;
        gameState.arrowsLeft = 5;
        gameState.isGameActive = true;
        
        // Reset target position
        target.x = initialTargetX;
        lineSegment.x1 = 875;
        lineSegment.x2 = 925;
        
        TweenMax.to("#target", 0.5, { x: 0 });
        TweenMax.to("#arc", 0.3, { attr: { d: "M100,250c250-400,550-400,800,0" } });
        
        // Clear arrows
        arrows.innerHTML = '';
        
        updateUI();
        document.getElementById('gameOverModal').style.display = 'none';
      }

      // Utility functions
      function getMouseSVG(e) {
        cursor.x = e.clientX;
        cursor.y = e.clientY;
        return cursor.matrixTransform(svg.getScreenCTM().inverse());
      }

      function getIntersection(segment1, segment2) {
        var dx1 = segment1.x2 - segment1.x1;
        var dy1 = segment1.y2 - segment1.y1;
        var dx2 = segment2.x2 - segment2.x1;
        var dy2 = segment2.y2 - segment2.y1;
        var cx = segment1.x1 - segment2.x1;
        var cy = segment1.y1 - segment2.y1;
        var denominator = dy2 * dx1 - dx2 * dy1;
        
        if (denominator == 0) {
          return null;
        }
        
        var ua = (dx2 * cy - dy2 * cx) / denominator;
        var ub = (dx1 * cy - dy1 * cx) / denominator;
        
        return {
          x: segment1.x1 + ua * dx1,
          y: segment1.y1 + ua * dy1,
          segment1: ua >= 0 && ua <= 1,
          segment2: ub >= 0 && ub <= 1
        };
      }

      // Initialize game when DOM is loaded
      document.addEventListener('DOMContentLoaded', initGame);
    </script>

    <!-- Firebase Service -->
    <script src="js/firebase-service.js"></script>
    <script src="js/ppo-blockchain-integration.js"></script>
    <script src="js/bow-customization.js"></script>
    <script src="js/game-economy-system.js"></script>
    
    <script>
      // Update wallet status when blockchain connection changes
      function updateWalletStatus() {
        const walletStatus = document.getElementById('walletStatus');
        if (window.PPOBlockchain && window.PPOBlockchain.isWalletConnected()) {
          walletStatus.className = 'wallet-status connected';
          walletStatus.innerHTML = '<i class="fas fa-wallet me-1"></i>Wallet Connected';
        } else {
          walletStatus.className = 'wallet-status disconnected';
          walletStatus.innerHTML = '<i class="fas fa-wallet me-1"></i>Wallet Disconnected';
        }
      }

      // Check wallet status periodically
      setInterval(updateWalletStatus, 2000);
      
      // Initial check
      document.addEventListener('DOMContentLoaded', updateWalletStatus);
    </script>
  
    <script src="js/system-integration.js"></script>
    
    <script src="js/system-validator.js"></script>
    </body>
</html>