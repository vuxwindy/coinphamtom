# Referral System Synchronization

## Vấn đề ban đầu

Trước đây, hệ thống referral có sự không đồng bộ giữa:
- **Home.vue**: Sử dụng hệ thống Firebase với `useFirebase` composable
- **Referral.vue**: Tạo ra hệ thống referral riêng biệt, không liên quan đến Firebase

Điều này dẫn đến:
- Mã referral khác nhau giữa 2 trang
- Dữ liệu không được đồng bộ
- Số liệu thống kê không chính xác

## Giải pháp đã thực hiện

### 1. Đồng bộ hóa Referral.vue với Home.vue

**Thay đổi chính:**
- Loại bỏ hệ thống referral riêng biệt trong Referral.vue
- Sử dụng cùng `useFirebase` composable như Home.vue
- Lấy dữ liệu referral từ Firebase thay vì tạo mock data

### 2. Cập nhật useFirebase composable

**Thêm function mới:**
```javascript
// Get referrals list for a user
const getReferralsList = async (userId = null) => {
  // Query Firebase để lấy danh sách users được refer bởi user hiện tại
  // Trả về thông tin chi tiết của từng referral
}
```

### 3. Cải thiện UX

**Thêm các tính năng:**
- Loading indicator khi đang tải dữ liệu
- Disable buttons khi chưa có referral code
- Error handling tốt hơn
- Toast notifications cho user feedback

## Cấu trúc dữ liệu Firebase

### User Document Structure
```javascript
{
  uid: "user_id",
  email: "user@example.com",
  displayName: "User Name",
  referralCode: "ABC12345", // Generated by Firebase
  referralCount: 5, // Number of successful referrals
  referralEarnings: 25, // Total PPO earned from referrals
  referredBy: "XYZ67890", // Referral code used when signing up
  level: "F1", // User level based on referrals
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### Referral Process
1. **User đăng ký**: Tự động tạo referral code
2. **User sử dụng referral code**: Cập nhật `referredBy` field
3. **Referrer nhận reward**: Tăng `referralCount` và `referralEarnings`

## Cách hoạt động

### Home.vue
```javascript
// Sử dụng useFirebase để lấy user data
const { currentUser, getUserData } = useFirebase()

const initializeReferral = async () => {
  const userData = await getUserData()
  userReferralCode.value = userData.data.referralCode
  // ... other logic
}
```

### Referral.vue (Đã cập nhật)
```javascript
// Sử dụng cùng useFirebase như Home.vue
const { currentUser, getUserData, getReferralsList } = useFirebase()

const loadReferralData = async () => {
  const userDataResult = await getUserData()
  userReferralCode.value = userDataResult.data.referralCode
  
  // Load real referrals data
  const referralsResult = await getReferralsList()
  referrals.value = referralsResult.data
}
```

## Lợi ích của việc đồng bộ hóa

### 1. Tính nhất quán
- Cùng một mã referral trên cả 2 trang
- Dữ liệu thống kê chính xác
- Trải nghiệm người dùng nhất quán

### 2. Bảo mật
- Dữ liệu được lưu trữ an toàn trên Firebase
- Không có dữ liệu giả (mock data)
- Tracking chính xác các referral

### 3. Khả năng mở rộng
- Dễ dàng thêm tính năng mới
- Có thể track được chi tiết từng referral
- Hỗ trợ multiple levels referral

## Testing

### File test: `test-referral-sync.html`
- Kiểm tra kết nối wallet
- Kiểm tra Firebase availability
- So sánh referral codes giữa các trang

### Manual Testing Steps
1. Connect wallet
2. Sign in to account
3. Check referral code trên Home page
4. Navigate to Referral page
5. Verify referral code matches
6. Test sharing functionality

## Các tính năng đã cải thiện

### 1. Loading States
- Hiển thị "Loading..." khi đang tải dữ liệu
- Disable buttons khi chưa sẵn sàng
- Spinner animation cho better UX

### 2. Error Handling
- Toast notifications cho errors
- Fallback data khi load thất bại
- Graceful degradation

### 3. Real-time Updates
- Watch cho wallet connection changes
- Watch cho user authentication changes
- Auto-refresh data khi cần thiết

## Future Improvements

### 1. Real-time Referral Tracking
- WebSocket connection để update real-time
- Push notifications cho new referrals
- Live counter updates

### 2. Advanced Analytics
- Referral conversion rates
- Geographic distribution
- Time-based analytics

### 3. Multi-level Referral System
- Support cho F1, F2, F3 levels
- Different commission rates per level
- Level-based rewards

## Troubleshooting

### Common Issues

1. **Referral code không hiển thị**
   - Kiểm tra wallet connection
   - Kiểm tra user authentication
   - Verify Firebase configuration

2. **Dữ liệu không đồng bộ**
   - Refresh page
   - Check network connection
   - Verify Firebase rules

3. **Share buttons không hoạt động**
   - Đảm bảo referral code đã load
   - Check browser permissions
   - Verify social media URLs

### Debug Commands
```javascript
// Check Firebase connection
console.log('Firebase ready:', window.firebase)

// Check user data
const { getUserData } = useFirebase()
getUserData().then(console.log)

// Check referrals
const { getReferralsList } = useFirebase()
getReferralsList().then(console.log)
```

## Kết luận

Việc đồng bộ hóa hệ thống referral đã:
- ✅ Đảm bảo tính nhất quán giữa Home.vue và Referral.vue
- ✅ Sử dụng cùng nguồn dữ liệu Firebase
- ✅ Cải thiện trải nghiệm người dùng
- ✅ Tăng tính bảo mật và độ tin cậy
- ✅ Chuẩn bị cho việc mở rộng trong tương lai

Hệ thống hiện tại đã sẵn sàng cho production và có thể handle được lượng users lớn.
